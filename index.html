<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>BTC 仪表盘 (永不亦错版)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #0b1121; color: #cbd5e1; font-family: system-ui, -apple-system, sans-serif; }
        .card { 
            background: #1e293b; 
            border: 1px solid #334155; 
            border-radius: 16px; 
            padding: 24px; 
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 180px;
        }
        .value-big { font-size: 3rem; font-weight: 800; line-height: 1.1; color: #f8fafc; }
        .label { font-size: 0.9rem; color: #94a3b8; margin-bottom: 12px; font-weight: 500; }
        .badge { 
            margin-top: 10px; 
            padding: 6px 16px; 
            border-radius: 20px; 
            font-size: 0.9rem; 
            font-weight: 700;
            display: inline-block;
        }
        /* 颜色配置 */
        .text-green { color: #4ade80; }
        .bg-green { background: rgba(74, 222, 128, 0.2); color: #4ade80; }
        .text-red { color: #f87171; }
        .bg-red { background: rgba(248, 113, 113, 0.2); color: #f87171; }
        .text-blue { color: #60a5fa; }
        .bg-blue { background: rgba(96, 165, 250, 0.2); color: #60a5fa; }
        .text-yellow { color: #facc15; }
        .bg-yellow { background: rgba(250, 204, 21, 0.2); color: #facc15; }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-6xl mx-auto">
        <div class="flex justify-between items-end mb-8 border-b border-gray-800 pb-4">
            <div>
                <h1 class="text-2xl md:text-3xl font-black text-white tracking-wider">BTC DASHBOARD</h1>
                <p class="text-xs text-gray-500 mt-1">Status: <span id="source-status">Auto</span></p>
            </div>
            <div class="text-right">
                <div id="status-dot" class="text-xs text-green-500 font-mono">● System Online</div>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            
            <div class="card relative overflow-hidden">
                <div class="label">恐惧 & 贪婪指数</div>
                <div id="fng-val" class="value-big">--</div>
                <div id="fng-badge" class="badge bg-gray-700 text-gray-400">正在分析...</div>
                <div class="absolute bottom-0 left-0 w-full h-1 bg-gray-700">
                    <div id="fng-bar" class="h-full transition-all duration-1000" style="width: 0%"></div>
                </div>
            </div>

            <div class="card border-blue-900/50 relative">
                <div class="absolute top-3 right-3 text-xs text-gray-600 font-mono">囤币指标</div>
                <div class="label">ahr999 Index</div>
                <div id="ahr-val" class="value-big">--</div>
                <div id="ahr-badge" class="badge bg-gray-700 text-gray-400">正在计算...</div>
            </div>

            <div class="card">
                <div class="label">BTC Price</div>
                <div id="btc-price" class="value-big text-yellow-400">--</div>
                <div id="price-change" class="text-sm font-bold mt-2">--%</div>
            </div>
        </div>

        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div class="bg-gray-800 rounded-xl p-4 text-center border border-gray-700">
                <div class="text-xs text-gray-500 mb-1">MA 120</div>
                <div id="ma120" class="text-lg font-bold text-white">--</div>
            </div>
            <div class="bg-gray-800 rounded-xl p-4 text-center border border-gray-700">
                <div class="text-xs text-gray-500 mb-1">MA 200</div>
                <div id="ma200" class="text-lg font-bold text-white">--</div>
            </div>
            <div class="bg-gray-800 rounded-xl p-4 text-center border border-gray-700">
                <div class="text-xs text-gray-500 mb-1">RSI (14)</div>
                <div id="rsi" class="text-lg font-bold text-white">--</div>
            </div>
            <div class="bg-gray-800 rounded-xl p-4 text-center border border-gray-700">
                <div class="text-xs text-gray-500 mb-1">减半倒计时</div>
                <div id="halving" class="text-lg font-bold text-blue-400">--</div>
            </div>
        </div>

        <div class="text-center mt-10 text-gray-600 text-xs">
            数据源: Binance 直连 + 智能容错系统
        </div>
    </div>

    <script>
        // 全局变量存储 RSI，用于救场
        let globalRSI = 50; 

        // === 1. 核心市场数据 (Binance) ===
        async function fetchMarket() {
            try {
                const res = await fetch("https://api.binance.com/api/v3/klines?symbol=BTCUSDT&interval=1d&limit=200");
                const data = await res.json();
                const prices = data.map(k => parseFloat(k[4]));
                const current = prices[prices.length - 1];
                const open = parseFloat(data[data.length - 1][1]);

                // 价格更新
                document.getElementById('btc-price').innerText = `$${Math.floor(current).toLocaleString()}`;
                const change = ((current - open) / open) * 100;
                const changeEl = document.getElementById('price-change');
                changeEl.innerText = (change>0?"+":"") + change.toFixed(2) + "%";
                changeEl.className = `text-sm font-bold mt-2 ${change>=0?"text-green":"text-red"}`;

                // MA 计算
                const ma120 = prices.slice(-120).reduce((a,b)=>a+b)/120;
                const ma200 = prices.reduce((a,b)=>a+b)/200;
                document.getElementById('ma120').innerText = `$${Math.floor(ma120)}`;
                document.getElementById('ma200').innerText = `$${Math.floor(ma200)}`;

                // RSI 计算
                let gains=0, losses=0;
                for(let i=prices.length-14; i<prices.length; i++){
                    let diff = prices[i]-prices[i-1];
                    if(diff>0) gains+=diff; else losses+=Math.abs(diff);
                }
                let rs = (gains/14) / (losses/14);
                globalRSI = 100 - (100/(1+(gains/losses))); // 更新全局RSI
                
                const rsiEl = document.getElementById('rsi');
                rsiEl.innerText = globalRSI.toFixed(1);
                rsiEl.className = `text-lg font-bold ${globalRSI<30?"text-green":(globalRSI>70?"text-red":"text-white")}`;

                // ahr999 计算
                const birth = new Date("2009-01-03").getTime();
                const now = new Date().getTime();
                const days = (now-birth)/86400000;
                const fit = Math.pow(10, 5.84 * Math.log10(days) - 17.01);
                const ahr = (current/fit) * (current/ma200);
                
                const ahrValEl = document.getElementById('ahr-val');
                const ahrBadge = document.getElementById('ahr-badge');
                
                ahrValEl.innerText = ahr.toFixed(3);
                
                if(ahr < 0.45) {
                    ahrValEl.className = "value-big text-green";
                    ahrBadge.className = "badge bg-green";
                    ahrBadge.innerText = "抄底 (Buy)";
                } else if(ahr < 1.2) {
                    ahrValEl.className = "value-big text-blue";
                    ahrBadge.className = "badge bg-blue";
                    ahrBadge.innerText = "定投 (DCA)";
                } else {
                    ahrValEl.className = "value-big text-red";
                    ahrBadge.className = "badge bg-red";
                    ahrBadge.innerText = "观望 (Wait)";
                }

                // 数据加载完后，尝试更新恐慌指数
                fetchFnG();

            } catch(e) { console.error(e); }
        }

        // === 2. 恐惧贪婪 (带 RSI 替补机制) ===
        async function fetchFnG() {
            try {
                // 尝试更强的代理 corsproxy.io
                let res = await fetch('https://corsproxy.io/?' + encodeURIComponent('https://api.alternative.me/fng/?limit=1'));
                if (!res.ok) throw new Error("API Blocked");
                
                const data = await res.json();
                const val = parseInt(data.data[0].value);
                const status = data.data[0].value_classification;
                updateFnGUI(val, status, "官方API");

            } catch (e) {
                console.warn("API连接失败，启用 RSI 智能拟合...");
                // ！！！救场逻辑！！！
                // 如果API挂了，直接用 RSI 近似替代
                // RSI < 30 = 恐惧，RSI > 70 = 贪婪
                let estVal = Math.round(globalRSI); 
                let estStatus = "中性";
                if(estVal < 30) estStatus = "极度恐惧";
                else if(estVal < 45) estStatus = "恐惧";
                else if(estVal > 70) estStatus = "贪婪";
                
                updateFnGUI(estVal, estStatus, "基于RSI拟合");
            }
        }

        function updateFnGUI(val, status, source) {
            const valEl = document.getElementById('fng-val');
            const badgeEl = document.getElementById('fng-badge');
            const barEl = document.getElementById('fng-bar');

            valEl.innerText = val;
            document.getElementById('source-status').innerText = source;
            
            let color = "text-gray-400";
            let bg = "bg-gray-700";
            let barColor = "#9ca3af";

            if (val <= 30) { // 极度恐惧
                color = "text-green"; bg = "bg-green"; barColor = "#4ade80";
            } else if (val <= 49) { // 恐惧
                color = "text-blue"; bg = "bg-blue"; barColor = "#60a5fa";
            } else if (val <= 70) { // 贪婪
                color = "text-yellow"; bg = "bg-yellow"; barColor = "#facc15";
            } else { // 极度贪婪
                color = "text-red"; bg = "bg-red"; barColor = "#f87171";
            }

            valEl.className = `value-big ${color}`;
            badgeEl.className = `badge ${bg}`;
            badgeEl.innerText = status;
            barEl.style.width = val + "%";
            barEl.style.backgroundColor = barColor;
        }

        // === 3. 减半倒计时 ===
        function updateHalving() {
            const target = new Date("2028-04-15").getTime();
            const days = Math.floor((target - new Date().getTime())/86400000);
            document.getElementById('halving').innerText = days + " 天";
        }

        // 启动
        fetchMarket(); // 先获取市场数据(包含RSI)
        updateHalving();
        setInterval(() => { fetchMarket(); }, 60000);
    </script>
</body>
</html>
